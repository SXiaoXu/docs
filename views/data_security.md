# 数据和安全

几乎每一位使用 LeanCloud 的开发者都会问，如何能够保证自己应用数据的安全？对安全的关注说明你也是位对产品负责、对用户负责、对自己负责、做事态度认真的开发者，这也正是 LeanCloud 所信守的价值观。

LeanCloud 提供的服务都是基于 HTTP 协议的，我们云端对客户端发过来的每一个请求，都进行了身份鉴别（Authentication）和访问授权（Authorization）的严格检查。

## 身份鉴别（Authentication）

访问 LeanCloud 的 API 需要提供应用的 AppID 和 AppKey（用于在客户端发起请求），或是 AppID 和 MasterKey（用于在云引擎、开发者自己的服务器等受信任的环境发起请求）。
Android SDK 还额外支持[仅使用 AppID 访问 LeanCloud API](sdk_setup_android_securely.html)。

使用 MasterKey 访问 LeanCloud API 会跳过所有的访问权限控制，所以请确保 MasterKey 不会泄露。
万一发生泄露，请立即前往「控制台 > 设置 > 应用 Keys > Credentials」重置 MasterKey。

在客户端使用 AppKey 访问 LeanCloud API 时，我们采用了一些加固措施：

1. 客户端访问 LeanCloud API 通过 HTTPS 加密通讯。
2. 通过 SDK 访问 LeanCloud API 时，HTTP Header 中不直接传输 AppKey。而是传输客户端根据 AppKey 和请求发起时间生成的签名字符串，供 LeanCloud 云端校验。开发者不通过 SDK，直接请求 REST API 时，也可以使用[这种更安全的鉴权方式](rest_api.html#更安全的鉴权方式)。

通过 HTTPS 加密通讯，不仅保护了数据安全，而且能避免 AppKey 被第三方窃取，但无法阻止别有用心的人通过在客户端使用抓包工具获取 AppKey。
通过签名字符串可以避免在网络传输过程中泄露 AppKey，但是无法阻止别有用心的人通过反编译等手段获取代码中初始化 SDK 时设定的 AppKey。
Android SDK 仅使用 AppID 的初始化方式，SDK 通过闭源的 native library 根据开发者配置的应用签名证书自动对请求进行签名。
这在一定程度上避免暴露了应用核心配置信息，也显著增加了破解的难度（反编译 native library 后仍需破解加密算法），但仍无法保证绝对的数据安全。
因此，**凡是需要在客户端访问的应用，都需要设定 ACL 等权限设置，以保障应用数据的安全性**。

## 访问授权（Authorization）

LeanCloud 支持在 Class （表）、字段（列）、对象三个不同的层次设置访问权限。

### Class 权限

Class 权限指整个 Class （整张表）的读写权限，需要在控制台进行设置。

创建 Class 的时候，控制台会弹出一个窗口，如下图：

![创建 Class 对话框](images/security/acl_template.png)

在这里，你可以设置 Class 的访问权限：

- `add_fields` - 给 Class 增加新的字段，也就是说，保存对象时，如果对应的字段（列）不存在，是否允许自动创建新的字段。如果已经在控制台创建好 Class 的所有字段，最好对任意用户都关闭此权限，防止脏数据写入。
- `create` - 在 Class 表中插入一个新对象。对于需要登录用户或者拥有指定授权的用户才能创建内容的场景，可以考虑根据情况设置此权限。
- `delete` - 删除既有对象。
- `update` - 修改既有对象。
- `find` - 通过指定条件查询对象。关闭此权限时，无法查询对象，只能通过 objectId 获取对象（如果没有同时关闭 `get` 权限），一定程度上可以防范别有用心的人批量抓取该 Class 下的所有对象。
- `get` - 通过 objectId 获取单个对象。

对于每一种权限，又可以开放给不同用户：

* 所有用户 － 相当于 public 权限。这里的「用户」泛指「客户端」，而不是 LeanCloud 内建账户系统的用户。也就是说，无论请求是否携带 sessionToken，携带的 sessionToken 是否有效，都可以进行这一操作，
* 登录用户 － 只有使用 LeanCloud 内建账户系统（`_User` 表）并且进行了登录的客户端（携带了有效 sessionToken 的请求），才可以执行这一操作。
* 指定用户 － 指定用户才可以执行这一操作。支持通过用户名、用户 的 objectId、角色名、角色 的 objectId 指定用户。

譬如我们有一个匿名发帖的应用，所有人都可以发表帖子，但是只有经过管理员审核后的帖子才能被展示出来。我们可以有两张表，第一张表用来存放审核前的帖子，这张表的 create 权限就可以开放给所有用户；第二张表用来存放审核后的帖子，这张表的 create 权限就只开放给管理员。

另外，针对已经存在的 Class 你可以更新默认 ACL 和访问权限。进入**控制台 > 存储 > 结构化数据**，选择一个 Class，再点击**权限**标签页。

### 字段权限

在控制台还可以设置每个字段的权限。
访问 **控制台 > 存储 > 结构化数据**，选择一个 Class，点击相应字段的下拉菜单，选择 **编辑**：

1. 勾选 **只读** 后，客户端无法更新这一字段。
2. 勾选 **客户端不可见** 后，客户端发起查询的时候，返回的结果将不包含这一字段。比如，匿名发帖的应用，你仍然希望发帖的时候，也记录下真实的作者，但不希望将此信息返回给客户端。

#### Object 级别的 ACL

最灵活的保护你应用数据安全的方式是通过访问控制列表（Access Control List），通常简称为「ACL 机制」。ACL 背后的机制是将每个操作授权给一部分 **用户**（User）或者 **角色**（Role），只允许这些用户或角色执行这些操作。例如，一个用户必须拥有读权限（或者属于一个拥有读权限的角色）才可以获取一个对象的数据，同时，一个用户需要拥有写权限（或者属于一个拥有写权限的角色）才可以更改或者删除一个对象。

ACL 工作的前提是**用户（User）**和**角色（Role）**。**用户（类名`_User`）**是 LeanCloud 内建的账户系统，自动支持用户注册、登录、验证等操作，详细内容请参考[用户系统](./rest_api.html#用户-1)。**角色（类名`_Role`）**是一种有名称的对象，包含了用户和其他角色（也就是说角色也有层次关系），将权限授予一个角色代表该角色所包含的其他角色也会得到相应的权限，详细内容请参考[文档：角色](./rest_api.html#角色-1)。


在 LeanCloud 中，还可以对 Class 中的每一条记录（Object）单独设置 ACL，这时是按照读、写分离来对不同用户、角色进行授权的。在应用控制台中进行操作的界面如下图所示：

![设置对象的 ACL 权限](images/acl.png)

这样我们就可以做到：

* 对于私有数据，read 和 write 都可以限制为对象创建者所有（其读写权限都设置成创建者自身，并且不开放「所有用户」的读、写权限）。
* 一个信息公告板的帖子，作者和属于「版主」角色的成员可拥有修改权限，普通访客则只允许 浏览（给「所有用户」开放「读」权限，给「作者」和「版主角色」开放「写」权限）。
* 应用内全局的每日头条，对所有用户是只读的，只有管理员可以修改它（给「所有用户」开放「读」权限，给「管理员角色」开放「写」权限）。
* 用户共享一篇文章给另一个用户，可以将读和写的访问许可限制到关联的这两个用户，其他人一概不可读写（对「所有用户」关闭「读、写」权限，只对两个用户开放权限）。

使用 LeanCloud SDK，你可以设置一个默认的 ACL 给客户端所有创建的对象。如果你同时开启允许匿名用户的功能，你可以保证你的数据拥有严格限制到每个单独用户的 ACL 权限。基于用户和角色的权限管理指南，详细信息请参考 [ACL 权限管理指南](acl-guide.html)。

### Web 应用安全设置
在通用的两层鉴权机制之外，我们单独讨论一下 Web 应用的安全问题。

对于 Web 应用来说，盗取 appId／appKey 的难度会更小一些，所以我们需要做一些特别的防御措施。关键点是，我们要能够保证其他人把你的 appId 偷过去之后，他也无法直接使用你的服务器资源。Web 端可以通过 `Web 安全域名` 来对请求来源做限制，可以简单的防御住 Web 的服务器资源盗取。

设置「Web 安全域名」后，仅可在该域名下通过 JavaScript SDK 调用服务器资源，域名配置策略与浏览器域安全策略一致，要求域名协议、域和端口号都需严格一致，不支持子域和通配符。所以如果你要配置一个域名，要写清楚协议、域和端口，缺少一个都可能导致访问被禁止。举例说明一下域名的区别：

```
// 跨域
www.a.com:8080
www.a.com

// 跨域 
www.a.com:8080
www.a.com:80

// 跨域  
a.com
www.a.com

// 跨域
xxx.a.com
www.a.com

// 不同协议，跨域         
http:
https:
```

这样就可以防止其他人通过外网其他地址盗用你的服务器资源。但是要注意，**Web 安全域名**所能达到的目的是防御恶意部署，而不是防御伪造脏数据（恶意用户通过绑定 host 方式还是有可能访问到应用的数据），所以要想对数据进行更多细粒度的控制，需要配合 ACL 来使用。

在 WebView 中使用，建议通过 WebView 去加载一个部署好的、有域名的 Web，然后缓存在本地，这样可以通过 **Web 安全域名** 来做限制。

如果在前端使用 JavaScript SDK，当你打算正式发布出去的时候，请务必配置 **Web 安全域名**，方法是进入 **控制台 > 设置 > 安全中心 > Web 安全域名**。

## 安全中心

安全中心，是我们为每个应用提供的设置基本安全的入口，位置在 控制台 > 设置 > 安全中心。除了之前讲过的**Web 安全域名**外，这里还可以设置或查看：


### 服务开关

服务开关，是用来开启或者关闭当前应用所使用的服务，从根本上防止由于 AppId 和 AppKey 泄露后而可能会引发的服务资源被盗取的问题。

![image](images/security/service-switch.png)

### 操作日志

操作日志中会显示应用创建者及所有协作者的重要操作记录，比如删除数据操作的历史、操作用户名、操作 IP 及操作时间等，这个日志的目的是为了遇到问题更好地定位故障缘由，排查可能的恶意操作，防止应用数据被错误地改动。

## 其它安全措施

### 应用安全选项

进入各自功能的设置页面，选中或取消选中列表项目即可启用或者关闭对应的功能，例如：

在 **控制台 > 存储 > 设置** 页面中：

- 用户账号 > **用户注册时，发送验证邮件**<br/>
  是否要求你应用里的注册用户验证邮箱， 默认不启用。如果启用，每次用户注册，都会发送一封邮件到用户提供的邮箱，要求认证，具体请看数据存储指南的用户一节。
- 其他 > **禁止客户端创建 Class**<br/>
  是否禁止客户端动态创建 Class。如果启用，新的 Class 将只能通过云端管理平台来创建，而无法通过 SDK 或者 REST API 方式来动态创建了。

在 **控制台 > 消息 > 推送 > 设置 > 推送选项** 页面中：

- **禁止从客户端进行消息推送**<br/>
  是否禁止从客户端推送消息。禁止后只能通过 **控制台 > 消息 > 推送 > 在线发送** 或带着 **master key** 调用 [推送消息 API ](push_guide.html#推送消息) 来推送消息。

如果想彻底关闭一个应用的数据存储、短信发送、消息推送和聊天（即时通讯）功能，请进入 **控制台 > 设置 > 安全中心** 来进行相应设置。

### 自动备份

LeanCloud 每天自动备份应用数据，防止用户误操作删除了重要数据。商用版可以在「控制台 > 存储 > 导入导出 > 备份恢复」恢复最近 7 天的数据（还可以指定需要恢复的 class 或 objectId）。
开发版不支持数据恢复。
此外，开发者也可以使用[数据导出功能](dashboard_guide.html#云端数据导出到本地)将应用数据备份到本地，导出功能商用版、开发版均可用。

### SSL 加密传输

首先，我们所有的 API 请求都通过 [SSL加密传输](http://zh.wikipedia.org/wiki/%E5%AE%89%E5%85%A8%E5%A5%97%E6%8E%A5%E5%B1%82)，保证传输过程中的数据安全性和可靠性。
### 第三方加固

对于 Android 应用，除了代码混淆之外，还可以使用第三方加密工具，隐藏 classes.dex，通过动态加载的方法进一步提高应用的安全性。下面我们简单介绍一下爱加密。

[爱加密](http://www.ijiami.cn/) 是专为移动开发者提供安全服务的一个平台，可解决开发者面临的应用安全问题。加密的步骤很简单：

1. 提交应用；
2. 下载加密后的 apk 文件；
3. 下载爱加密提供的签名工具，对应用进行签名。

相关步骤还可以见下面的截图。

申请账号，提交应用，下载签名工具：

![image](images/ijiami_2.png)

加密后重新签名：

![image](images/ijiami_1.png)

这样得到的 apk 文件，普通的反编译之后得到的是，

![image](images/decompile.png)

可以看到，代码被隐藏起来了，应用被破解的难度大幅增加了。

对于任何移动应用来说。因为客户端代码运行在一台移动设备上，因此可能会有不受信任的客户强行修改代码并发起恶意的请求。选择正确的方式来保护你的应用非常重要，但是正确的方式取决于你的应用，以及应用存储的数据。

我们提供多种方式使用权限控制来获得安全性。如果你有关于任何保护你应用安全的最佳方式的问题，我们都鼓励你联系我们的客户支持。我们一直努力提供更多功能给开发者来保护你的应用，也希望大家持续地给我们反馈，感谢。
